<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MiniApp</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
* { box-sizing: border-box; }
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif;
  background:#f3f5f9;
}

#loading{
  height:100vh;
  display:none;
  align-items:center;
  justify-content:center;
  padding:24px;
  text-align:center;
  color:#333;
}
#loading .box{
  background:#fff;
  width:min(520px, 92vw);
  border-radius:18px;
  padding:22px;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
}
#loading h2{ margin:0 0 8px; font-size:20px; }
#loading p{ margin:0; color:#666; }

#app{ display:none; }

header{
  background:linear-gradient(90deg,#6a6df5,#4cc9f0);
  color:#fff;
  padding:20px;
  border-radius:0 0 20px 20px;
  position:relative;
}

.balance{ font-size:28px; font-weight:800; }

.profile{
  position:absolute;
  top:15px;
  right:15px;
  cursor:pointer;
  user-select:none;
}

.profile img{
  width:36px;
  height:36px;
  border-radius:50%;
  border:2px solid rgba(255,255,255,.6);
  background:rgba(255,255,255,.2);
}

.cards{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  padding:15px;
}

.card{
  background:#fff;
  border-radius:15px;
  padding:15px;
  box-shadow:0 5px 10px rgba(0,0,0,.05);
  min-height:70px;
}

.card small{ color:#777; }

.page{ display:none; padding-bottom:100px; }

.box{
  margin:15px;
  background:#fff;
  border-radius:18px;
  padding:16px;
  box-shadow:0 5px 10px rgba(0,0,0,.05);
}

.btn{
  margin-top:10px;
  width:100%;
  border:none;
  border-radius:12px;
  padding:12px;
  background:#6a6df5;
  color:#fff;
  font-size:15px;
  cursor:pointer;
}
.btn.secondary{
  background:#eef1ff;
  color:#3438d4;
}

.bottom{
  position:fixed;
  bottom:0;
  width:100%;
  background:#fff;
  display:flex;
  justify-content:space-around;
  border-top:1px solid #ddd;
  padding:10px 0;
}

.bottom button{
  background:none;
  border:none;
  font-size:13px;
  cursor:pointer;
  color:#777;
  width:25%;
}

.bottom button.active{
  color:#6a6df5;
  font-weight:800;
}

#profileMenu{
  position:absolute;
  top:60px;
  right:15px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 5px 20px rgba(0,0,0,.15);
  display:none;
  min-width:260px;
  overflow:hidden;
  z-index:10;
}
.profile-line{
  padding:12px 14px;
  font-size:13px;
  color:#333;
  border-bottom:1px solid #eee;
}
#profileMenu button{
  padding:12px 14px;
  background:none;
  border:none;
  width:100%;
  text-align:left;
  cursor:pointer;
}
.muted{ color:#666; font-size:14px; }
pre{
  white-space:pre-wrap;
  background:#0b1020;
  color:#d8e1ff;
  padding:12px;
  border-radius:12px;
  overflow:auto;
  font-size:12px;
  line-height:1.35;
}
</style>
</head>

<body>

<div id="loading">
  <div class="box">
    <h2 id="loadTitle">Naƒç√≠t√°m‚Ä¶</h2>
    <p id="loadMsg">Ovƒõ≈ôuji Telegram √∫ƒçet</p>
  </div>
</div>

<div id="app">
  <header>
    <h2 style="margin:0 0 8px;">V√Ωdƒõlky</h2>
    <div style="opacity:.9">Z≈Østatek</div>
    <div class="balance" id="balanceText">Kƒç 0</div>

    <div class="profile" onclick="toggleProfile()">
      <img id="avatar" src="https://i.imgur.com/0y0y0y0.png" alt="profil" />
    </div>

    <div id="profileMenu">
      <div class="profile-line">üë§ <b id="profileName">-</b></div>
      <div class="profile-line">üÜî TG ID: <span id="profileId">-</span></div>
      <div class="profile-line muted">Data se ukl√°daj√≠ do Supabase</div>
      <button onclick="closeProfile()">Zav≈ô√≠t menu</button>
    </div>
  </header>

  <!-- HOME -->
  <div id="home" class="page">
    <div class="cards">
      <div class="card">üí∞<br><b id="statEarn">0</b><br><small>Celkov√Ω v√Ωdƒõlek</small></div>
      <div class="card">üë•<br><b id="statInv">0</b><br><small>Pozv√°no</small></div>
      <div class="card">üìã<br><b id="statTasks">0</b><br><small>√ökoly</small></div>
      <div class="card">‚ñ∂Ô∏è<br><b id="statVideos">0</b><br><small>Videa</small></div>
    </div>

    <div class="box">
      <h3 style="margin:0 0 8px;">Pozvƒõte a vydƒõl√°vejte</h3>
      <div class="muted">Pozvƒõte p≈ô√°tele a z√≠skejte odmƒõnu za ka≈æd√©ho nov√©ho u≈æivatele.</div>
      <button class="btn" onclick="invite()">Pozvat p≈ô√°tele</button>
    </div>
  </div>

  <!-- INVITE -->
  <div id="invite" class="page">
    <h2 style="padding:15px;margin:0;">Pozvat</h2>
    <div class="box">
      <div class="muted">Tady je tv≈Øj invite link:</div>
      <pre id="inviteLink">-</pre>
      <button class="btn secondary" onclick="copyInvite()">Kop√≠rovat</button>
      <button class="btn" onclick="addInviteTest()">+1 pozv√°nka (test)</button>
    </div>
  </div>

  <!-- VIDEO -->
  <div id="video" class="page">
    <h2 style="padding:15px;margin:0;">Videa</h2>
    <div class="box">
      <div class="muted">Test: p≈ôidat video view</div>
      <button class="btn" onclick="addVideoTest()">+1 video (test)</button>
    </div>
  </div>

  <!-- WALLET -->
  <div id="wallet" class="page">
    <h2 style="padding:15px;margin:0;">Penƒõ≈æenka</h2>
    <div class="box">
      <div class="muted">Test: p≈ôidat v√Ωdƒõlek</div>
      <button class="btn" onclick="addMoneyTest()">+100 Kƒç (test)</button>
      <button class="btn secondary" onclick="resetStats()">Reset (test)</button>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <div class="bottom">
    <button id="b-home" onclick="go('home')">üè†<br>Dom≈Ø</button>
    <button id="b-invite" onclick="go('invite')">üë•<br>Pozvat</button>
    <button id="b-video" onclick="go('video')">‚ñ∂Ô∏è<br>Video</button>
    <button id="b-wallet" onclick="go('wallet')">üí∞<br>Penƒõ≈æenka</button>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const EDGE_URL = "https://kwrdcaoxecqfctlcjnbj.functions.supabase.co/hyper-endpoint";
const SUPABASE_URL = "https://kwrdcaoxecqfctlcjnbj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3cmRjYW94ZWNxZmN0bGNqbmJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNjIzNzYsImV4cCI6MjA4NDYzODM3Nn0.IZdO-tEDsMwBmZ020bvBT_IOOrqgo7LwHKOStHcp6eg"; // <-- sem vlo≈æ sv≈Øj anon key

const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const tg = window.Telegram?.WebApp;

/* ===== LOADING delay (no blinking) ===== */
let loadingTimer = null;
function showLoadingDelayed() {
  loadingTimer = setTimeout(() => {
    document.getElementById("loading").style.display = "flex";
  }, 300);
}
function hideLoadingDelayed() {
  clearTimeout(loadingTimer);
  loadingTimer = null;
  document.getElementById("loading").style.display = "none";
}

/* ===== STATE ===== */
let currentUser = null; // { telegram_id, ... }
let stats = null;       // { balance_czk, invite_count, task_count, video_count }

/* ===== UI ===== */
function go(page) {
  document.querySelectorAll(".page").forEach(p => p.style.display = "none");
  document.getElementById(page).style.display = "block";

  document.querySelectorAll(".bottom button").forEach(b => b.classList.remove("active"));
  const btn = document.getElementById("b-" + page);
  if (btn) btn.classList.add("active");

  closeProfile();
}

function toggleProfile() {
  const m = document.getElementById("profileMenu");
  m.style.display = (m.style.display === "block") ? "none" : "block";
}
function closeProfile(){ document.getElementById("profileMenu").style.display = "none"; }

function moneyFmt(n){ return "Kƒç " + (Number(n)||0).toLocaleString("cs-CZ"); }

function render() {
  const b = stats?.balance_czk ?? 0;
  const inv = stats?.invite_count ?? 0;
  const tasks = stats?.task_count ?? 0;
  const vids = stats?.video_count ?? 0;

  document.getElementById("balanceText").innerText = moneyFmt(b);
  document.getElementById("statEarn").innerText = (Number(b)||0).toLocaleString("cs-CZ");
  document.getElementById("statInv").innerText = inv;
  document.getElementById("statTasks").innerText = tasks;
  document.getElementById("statVideos").innerText = vids;

  const botUsername = "ROBINVOZDECKYAPP"; // kdybys chtƒõl pozv√°nky p≈ôes bot link
  const ref = currentUser?.telegram_id || "0";
  document.getElementById("inviteLink").textContent =
    `https://t.me/${botUsername}?start=${ref}`;
}

/* ===== TELEGRAM LOGIN ===== */
async function telegramAutoLogin() {
  showLoadingDelayed();

  if (!tg) {
    hideLoadingDelayed();
    document.body.innerHTML = "Neotev≈ôeno v Telegramu (Mini App).";
    return;
  }

  tg.expand();

  const initData = tg.initData || "";
  if (!initData) {
    hideLoadingDelayed();
    document.body.innerHTML = "Chyb√≠ initData ‚Äì otev≈ôi to p≈ôes Telegram Mini App.";
    return;
  }

  try {
    const res = await fetch(EDGE_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ initData })
    });

    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { ok:false, error:"Non-JSON response", raw:text }; }

    if (!res.ok || !data.ok) {
      hideLoadingDelayed();
      document.body.innerHTML =
        "<div style='padding:20px;font-family:Arial'>" +
        "<b>Login fail</b><br><br>" +
        "HTTP: " + res.status + "<br>" +
        "Error: " + (data.error || "unknown") + "<br>" +
        "<pre style='white-space:pre-wrap;background:#111;color:#fff;padding:10px;border-radius:10px;'>" +
        (data.raw || text) +
        "</pre></div>";
      return;
    }

    currentUser = data.user;

    // profile
    document.getElementById("profileName").innerText =
      (currentUser.first_name || "") + (currentUser.username ? " @" + currentUser.username : "");
    document.getElementById("profileId").innerText = currentUser.telegram_id;
    if (currentUser.photo_url) document.getElementById("avatar").src = currentUser.photo_url;

    // show app
    hideLoadingDelayed();
    document.getElementById("app").style.display = "block";
    go("home");

    // load stats from DB
    await ensureStatsRow();
    await loadStats();

  } catch (e) {
    hideLoadingDelayed();
    document.body.innerHTML = "Network/CORS error: " + String(e);
  }
}

/* ===== DB (Supabase) ===== */

// ensure row exists
async function ensureStatsRow() {
  const telegram_id = currentUser.telegram_id;

  // try select
  const { data: row, error } = await supa
    .from("stats")
    .select("*")
    .eq("telegram_id", telegram_id)
    .maybeSingle();

  // if table missing or rls error -> show message
  if (error && !row) {
    console.log(error);
    alert("Chyba DB: " + error.message + "\n\nZkontroluj, ≈æe existuje tabulka stats.");
    return;
  }

  if (!row) {
    // create default
    const { error: insErr } = await supa.from("stats").insert([{
      telegram_id,
      balance_czk: 0,
      invite_count: 0,
      task_count: 0,
      video_count: 0
    }]);
    if (insErr) alert("Insert stats failed: " + insErr.message);
  }
}

// load stats
async function loadStats() {
  const telegram_id = currentUser.telegram_id;
  const { data, error } = await supa
    .from("stats")
    .select("*")
    .eq("telegram_id", telegram_id)
    .single();

  if (error) {
    alert("Load stats failed: " + error.message);
    return;
  }

  stats = data;
  render();
}

// update helper
async function updateStats(patch) {
  const telegram_id = currentUser.telegram_id;
  const { error } = await supa
    .from("stats")
    .update({ ...patch, updated_at: new Date().toISOString() })
    .eq("telegram_id", telegram_id);

  if (error) {
    alert("Update failed: " + error.message);
    return false;
  }
  await loadStats();
  return true;
}

/* ===== ACTIONS ===== */
function invite() { go("invite"); }

async function copyInvite() {
  const t = document.getElementById("inviteLink").textContent;
  try {
    await navigator.clipboard.writeText(t);
    alert("Zkop√≠rov√°no ‚úÖ");
  } catch {
    alert("Ne≈°lo zkop√≠rovat. Zkop√≠ruj ruƒçnƒõ:\n" + t);
  }
}

// TEST: +100 Kƒç
async function addMoneyTest() {
  const b = Number(stats?.balance_czk || 0) + 100;
  await updateStats({ balance_czk: b });
}

// TEST: +1 pozv√°nka
async function addInviteTest() {
  const v = Number(stats?.invite_count || 0) + 1;
  await updateStats({ invite_count: v });
}

// TEST: +1 video
async function addVideoTest() {
  const v = Number(stats?.video_count || 0) + 1;
  await updateStats({ video_count: v });
}

// TEST: reset
async function resetStats() {
  await updateStats({ balance_czk: 0, invite_count: 0, task_count: 0, video_count: 0 });
}

/* start */
telegramAutoLogin();
</script>

</body>
</html>

